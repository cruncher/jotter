<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="author" content="" />
	<meta name="description" content="" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />

	<title id="title">Jotter{[data.name|yesno:' ✎ ']}{[data.name]}</title>

	<!-- Bolt requires this. -->
	<script>document.documentElement.className = 'js';</script>

	<link rel="icon" type="image/png" href="images/favicon.png" />
	<link rel="apple-touch-icon" href="/apple-touch-icon.png" />

	<link rel="stylesheet" href="bolt/css/normalise.css" />
	<link rel="stylesheet" href="bolt/css/form.css" />
	<link rel="stylesheet" href="bolt/css/block.css" />
	<link rel="stylesheet" href="bolt/css/card.css" />
	<link rel="stylesheet" href="bolt/css/index.css" />
	<link rel="stylesheet" href="bolt/css/layer.css" />
	<link rel="stylesheet" href="bolt/css/button.css" />
	<link rel="stylesheet" href="bolt/css/thumb.css" />
	<link rel="stylesheet" href="bolt/css/grid.css" />
	<link rel="stylesheet" href="bolt/css/text.css" />
	<link rel="stylesheet" href="bolt/css/color.css" />
	<link rel="stylesheet" href="bolt/css/utilities.css" />
	<link rel="stylesheet" href="bolt/css/dom.css" />
	<link rel="stylesheet" href="bolt/css/nav.css" />
	<link rel="stylesheet" href="bolt/css/space.css" />
	<link rel="stylesheet" href="bolt/css/action.css" />
	<link rel="stylesheet" href="css/form.css" />
	<link rel="stylesheet" href="css/dom.css" />
	<link href='https://fonts.googleapis.com/css?family=Inconsolata:400,700' rel='stylesheet' />
</head>

<body id="body" class="{[data.html-active|yesno:'html-active']} {[requested|yesno: 'unsaved']}">
	<input type="text" class="name-layer layer" placeholder="✎ Title" name="{[data.name]}" value="" maxlength="128" />
	<label class="html-button button" for="html-toggle">
		HTML
		<input type="checkbox" class="masked" id="html-toggle" name="{[data.html-active]} "/>
	</label>
	<button type="button" class="delete-button {[requested|yesno: 'disabled']}" data-fn="delete-on-click">Delete</button>
	<textarea class="text-layer layer hidden-scroll" placeholder="✎" name="{[data.text]}"></textarea>
	<div class="html-layer layer" data-scope="{[data.text]}" data-fn="sparkify"></div>
	<script src="bolt/js/jquery-2.1.4.js"></script>
	<script src="bolt/package/js/bolt-0.9.8.js"></script>
	<script src="sparky/package/sparky.js"></script>
	<script src="sparky/js/sparky.fn.js"></script>
	<script src="sparky/js/sparky.filters.js"></script>
	<script src="js/config.js"></script>
	<script>
(function(window) {
	var assign = Object.assign;
	var Sparky = window.Sparky;
	var storage = window.localStorage;
	var slugify = Sparky.filters.slugify;

	var path = '/jotter/';
	var rallspaces =  /^\s*$/;

	var data = {
		slug: '',
		name: '',
		text: '',
		'html-active': false
	};

	var scope = {
		data: data
	};

	var title = Sparky('title', data, returnScope);
	var editor = Sparky('body', data, function(){
		assign(this.fn, {
			'delete-on-click': deleteOnClick,
			'sparkify': sparkify
		});

		return scope;
	});

	function returnScope() {
		return scope;
	}

	function setupStorage(storage) {
		if (!storage.getItem('')) {

			storage.setItem('', JSON.stringify({
				slug: '',
				name: '',
				text: 'This is Jotter.\n\n' +
					'To show a jot enter it\'s name in the title bar.\n' +
					'To create or edit the jot, start typing.\n' +
					'Jots are saved locally as you type.\n\n' +
					'Type \'index\' for a jot that lists your jots.\n',
				'html-active': false
			}));
		}

		if (!storage.getItem('index')) {
			storage.setItem('index', JSON.stringify({
				slug: 'index',
				name: 'Index',
				text: '<h1 class="text-2">Jots</h1>\n\n' +
					'<ul class="index">\n' +
					'  <li>\n' +
					'    <a href="./">/</a>\n' +
					'  </li>\n' +
					'  <li data-scope="{[jots]}" data-fn="each">\n' +
					'    <a href="{[slug]}">{[name]}</a>\n' +
					'  </li>\n' +
					'</ul>\n',
				'html-active': true
			}));
		}
	}

	function deleteOnClick(node) {
		node.addEventListener('click', function(e) {
			storage.removeItem(data.slug);
			load();
		});
	}

	function sparkify(node) {
		var content;
		var fns = this.interrupt();

		this.on('scope', function(sparky, html) {
			if (content) { content.destroy(); }
			content = undefined;

			if (!html) { return; }

			var template = Sparky.dom.create('div');
			template.innerHTML = html;

			content = sparky.create(template, undefined, function(node) {
				return {
					barf: 'Barf!',
					jots: getLocalJots()
				};
			});

			Sparky.dom.append(node, content);
		});
	}

	function getLocalJots() {
		var array = [];
		var slug;

		for (slug in storage) {
			array.push(JSON.parse(storage[slug]));
		}

		return Collection(array, { index: 'slug' });
	}

	function update(){
		scope.requested = true;
	}

	function Throttle(fn, time) {
		var flag = false;
		var context, args;

		function update() {
			fn.apply(context, args);
			flag = false;
		}

		return function() {
			context = this;
			args = arguments;

			if (flag) { return; }
			flag = true;

			setTimeout(update, time);
		};
	}

	var save = Throttle(function save() {
		if (!data.text || rallspaces.exec(data.text)) {
			return;
		}

		var location = window.location;

		data.slug = slugify(data.name);
		storage.setItem(data.slug, JSON.stringify(data));
		console.log('Saved', data.slug);
		window.history.pushState(data, data.name, path + data.slug);
		scope.requested = false;
	}, 500);

	var load = Throttle(function load() {
		var json = storage.getItem(slugify(data.name));

		Sparky.unobserve(data, 'name', save);
		Sparky.unobserve(data, 'name', load);
		Sparky.unobserve(data, 'text', save);
		Sparky.unobserve(data, 'text', update);
		Sparky.unobserve(data, 'html-active', save);

		if (json) {
			console.log('Loaded', slugify(data.name));
			assign(data, JSON.parse(json));
		}
		else {
			scope.requested = true;
			data.text = '';
			data.slug = '';
			data['html-active'] = false;
		}

		Sparky.observe(data, 'name', save, false);
		Sparky.observe(data, 'name', load, false);
		Sparky.observe(data, 'text', save, false);
		Sparky.observe(data, 'text', update, false);
		Sparky.observe(data, 'html-active', save, false);
	}, 100);

	setupStorage(storage);
	load();

	window.jots = getLocalJots();
	window.data = data;
})(this);
	</script>
	<script src="upup.min.js"></script>
	<script>
	UpUp.start({
		'content-url': 'index.html',
		'assets': [
			"bolt/css/normalise.css",
			"bolt/css/form.css",
			"bolt/css/block.css",
			"bolt/css/card.css",
			"bolt/css/index.css",
			"bolt/css/layer.css",
			"bolt/css/button.css",
			"bolt/css/thumb.css",
			"bolt/css/grid.css",
			"bolt/css/text.css",
			"bolt/css/color.css",
			"bolt/css/utilities.css",
			"bolt/css/dom.css",
			"bolt/css/nav.css",
			"bolt/css/space.css",
			"bolt/css/action.css",
			"css/form.css",
			"css/dom.css",
			"https://fonts.googleapis.com/css?family=Inconsolata:400,700",

			"bolt/js/jquery-2.1.4.js",
			"bolt/package/js/bolt-0.9.8.js",
			"upup.min.js",
			"sparky/package/sparky.js",
			"js/config.js"
		]
	});
	</script>
</body>
</html>
